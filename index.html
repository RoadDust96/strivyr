<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strivyr Survey - Domain Reconnaissance Tool</title>
  <link rel="stylesheet" href="css/styles-modern.css" />
  <link rel="stylesheet" href="css/survey-modern.css" />
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="images/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="images/favicon.svg" />
  <link rel="shortcut icon" href="images/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Strivyr" />
  <link rel="manifest" href="images/site.webmanifest" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="nav-container">
      <a href="index.html" class="logo"><img src="images/logo.png" alt="Strivyr" /></a>
      <ul class="nav-links" id="nav-links">
        <li><a href="index.html" class="active">Strivyr Survey</a></li>
        <li><a href="about.html">About</a></li>
        <li class="nav-dropdown">
          <a href="#" class="nav-dropdown-toggle">Projects</a>
          <div class="nav-dropdown-menu">
            <a href="tip-calculator.html">Tip Calculator</a>
            <a href="f1.html">F1 Countdown</a>
          </div>
        </li>
      </ul>
      <button class="menu-toggle" id="menu-toggle">â˜°</button>
    </div>
  </nav>

  <main>
    <!-- Hero Section -->
    <section class="hero hero-compact">
      <div class="hero-content">
        <h1 class="hero-title">Strivyr Survey</h1>
        <p class="hero-subtitle">Comprehensive domain reconnaissance and DNS analysis tool</p>
      </div>
    </section>

    <!-- Survey Tool Section -->
    <section class="section-compact">
      <div class="survey-container">
        <!-- Domain Input -->
        <div class="domain-input-section">
          <form id="domain-form" class="domain-form">
            <input
              type="text"
              id="domain-input"
              class="domain-input"
              placeholder="example.com"
              required
              pattern="[a-zA-Z0-9.-]+"
            />
            <button type="submit" class="submit-btn" id="submit-btn">
              Scan Domain
            </button>
          </form>
          <div id="error-message" class="error-message" style="display: none;"></div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-state" style="display: none;">
          <div class="spinner"></div>
          <p>Scanning domain...</p>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="results-section">
          <div class="results-header">
            <h2 class="domain-title" id="domain-title"></h2>
          </div>

          <!-- Radar Chart -->
          <div class="chart-container">
            <div class="chart-wrapper">
              <canvas id="radar-chart"></canvas>
            </div>
          </div>

          <!-- Data Table -->
          <div class="table-container">
            <div class="table-controls">
              <div class="export-buttons">
                <button class="export-btn" id="export-csv">Download CSV</button>
                <button class="export-btn" id="export-json">Download JSON</button>
              </div>
              <input
                type="text"
                id="search-box"
                class="search-box"
                placeholder="Search results..."
              />
              <span class="pagination-info" id="pagination-info"></span>
            </div>

            <table class="data-table">
              <thead>
                <tr>
                  <th class="sortable" data-column="type">Type</th>
                  <th class="sortable" data-column="value">Value</th>
                </tr>
              </thead>
              <tbody id="table-body">
              </tbody>
            </table>

            <div class="pagination" id="pagination"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Strivyr. Domain reconnaissance and security tools.</p>
    </div>
  </footer>

  <script>
    // State management
    let apiResponse = null;
    let tableData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let sortColumn = null;
    let sortDirection = 'asc';
    let radarChart = null;

    // Security: Input sanitization utility
    const sanitizeHTML = (str) => {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    };

    // Sanitize and validate domain input
    const sanitizeDomain = (domain) => {
      if (!domain) return '';
      // Remove any HTML tags, scripts, and dangerous characters
      let sanitized = sanitizeHTML(domain);
      // Allow only alphanumeric, dots, hyphens, and underscores
      sanitized = sanitized.replace(/[^a-zA-Z0-9.-]/g, '');
      // Remove leading/trailing dots and hyphens
      sanitized = sanitized.replace(/^[.-]+|[.-]+$/g, '');
      return sanitized.toLowerCase();
    };

    // DOM elements
    const domainForm = document.getElementById('domain-form');
    const domainInput = document.getElementById('domain-input');
    const submitBtn = document.getElementById('submit-btn');
    const errorMessage = document.getElementById('error-message');
    const loadingState = document.getElementById('loading-state');
    const resultsSection = document.getElementById('results-section');
    const domainTitle = document.getElementById('domain-title');
    const searchBox = document.getElementById('search-box');
    const tableBody = document.getElementById('table-body');
    const paginationInfo = document.getElementById('pagination-info');
    const pagination = document.getElementById('pagination');
    const exportCsvBtn = document.getElementById('export-csv');
    const exportJsonBtn = document.getElementById('export-json');

    // Mobile menu toggle
    const menuToggle = document.getElementById('menu-toggle');
    const navLinks = document.getElementById('nav-links');

    menuToggle.addEventListener('click', () => {
      navLinks.classList.toggle('active');
    });

    // Form submission
    domainForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const rawDomain = domainInput.value.trim();

      if (!rawDomain) return;

      // Sanitize domain input
      const domain = sanitizeDomain(rawDomain);

      if (!domain) {
        showError('Invalid domain format. Please enter a valid domain name.');
        return;
      }

      // Validate domain format
      if (domain.length < 3 || domain.length > 253) {
        showError('Domain name must be between 3 and 253 characters.');
        return;
      }

      // Reset state
      errorMessage.style.display = 'none';
      resultsSection.classList.remove('visible');
      loadingState.style.display = 'block';
      submitBtn.disabled = true;

      try {
        console.log('Sending request to API for domain:', domain);

        const response = await fetch('https://survey.strivyr.com/api/lookup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ domain: domain })
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('API error response:', errorText);
          throw new Error(`API returned status ${response.status}: ${errorText || 'Unknown error'}`);
        }

        apiResponse = await response.json();
        console.log('API response:', apiResponse);
        processResults(domain, apiResponse);

      } catch (error) {
        console.error('Error details:', error);

        // Provide more specific error messages
        let errorMsg = 'Failed to scan domain. ';

        if (error.message === 'Failed to fetch') {
          errorMsg += 'This is likely a CORS issue. The API server needs to allow requests from this domain. Please check: (1) Is the API server running? (2) Does it have CORS enabled? (3) Is the URL correct?';
        } else if (error.message.includes('NetworkError')) {
          errorMsg += 'Network error - please check your internet connection and verify the API server is running.';
        } else {
          errorMsg += error.message;
        }

        showError(errorMsg);
      } finally {
        loadingState.style.display = 'none';
        submitBtn.disabled = false;
      }
    });

    // Process API results
    function processResults(domain, data) {
      // Sanitize domain before displaying
      domainTitle.textContent = sanitizeDomain(domain);

      // Build table data
      tableData = buildTableData(data);
      filteredData = [...tableData];
      currentPage = 1;

      // Create radar chart
      createRadarChart(data);

      // Render table
      renderTable();

      // Show results
      resultsSection.classList.add('visible');
    }

    // Build table data from API response
    function buildTableData(data) {
      const rows = [];

      // Helper to add rows
      const addRows = (type, items, fieldKey = null) => {
        if (!items) return;

        if (Array.isArray(items)) {
          items.forEach((item, index) => {
            if (typeof item === 'object') {
              Object.entries(item).forEach(([key, value]) => {
                rows.push({
                  type: type,
                  value: Array.isArray(value) ? value.join(', ') : String(value)
                });
              });
            } else {
              rows.push({
                type: type,
                value: String(item)
              });
            }
          });
        } else if (typeof items === 'object') {
          Object.entries(items).forEach(([key, value]) => {
            rows.push({
              type: type,
              value: Array.isArray(value) ? value.join(', ') : String(value)
            });
          });
        }
      };

      // Special handler for MX records to combine priority and exchange
      const addMxRows = (items) => {
        if (!items || !Array.isArray(items) || items.length === 0) return;

        items.forEach(item => {
          if (typeof item === 'object') {
            const hasPriority = 'priority' in item && item.priority !== null && item.priority !== undefined;
            const hasExchange = 'exchange' in item && item.exchange !== null && item.exchange !== undefined;

            // Display if either field is populated
            if (hasPriority || hasExchange) {
              const priorityValue = hasPriority ? item.priority : '(Priority)';
              const exchangeValue = hasExchange ? item.exchange : '(Exchange)';
              rows.push({
                type: 'MX Records',
                value: `${priorityValue}:${exchangeValue}`
              });
            }
          }
        });
      };

      // Process each data type
      if (data.dns) {
        addRows('A Records', data.dns.A);
        addRows('AAAA Records', data.dns.AAAA);
        addRows('CNAME Records', data.dns.CNAME);
        addMxRows(data.dns.MX); // Use special handler for MX records
        addRows('TXT Records', data.dns.TXT);
        addRows('NS Records', data.dns.NS);
        addRows('SOA Records', data.dns.SOA);
      }

      if (data.subdomains) {
        addRows('Subdomains', data.subdomains);
      }

      if (data.ssl) {
        addRows('SSL Certificates', data.ssl);
      }

      if (data.whois) {
        addRows('WHOIS', data.whois);
      }

      return rows;
    }

    // Create radar chart
    function createRadarChart(data) {
      const chartData = {
        'A Records': getCount(data.dns?.A),
        'AAAA Records': getCount(data.dns?.AAAA),
        'CNAME Records': getCount(data.dns?.CNAME),
        'MX Records': getCount(data.dns?.MX),
        'TXT Records': getCount(data.dns?.TXT),
        'NS Records': getCount(data.dns?.NS),
        'SOA Records': getCount(data.dns?.SOA),
        'Subdomains': getCount(data.subdomains),
        'SSL Certificates': getCount(data.ssl),
        'WHOIS Fields': getCount(data.whois)
      };

      const ctx = document.getElementById('radar-chart');

      // Destroy existing chart
      if (radarChart) {
        radarChart.destroy();
      }

      radarChart = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: Object.keys(chartData),
          datasets: [{
            label: 'Metadata Count',
            data: Object.values(chartData),
            backgroundColor: 'rgba(0, 255, 249, 0.1)',
            borderColor: 'rgba(0, 255, 249, 1)',
            borderWidth: 3,
            pointBackgroundColor: 'rgba(0, 255, 249, 1)',
            pointBorderColor: '#000000',
            pointHoverBackgroundColor: 'rgba(0, 255, 249, 1)',
            pointHoverBorderColor: '#ffffff',
            pointRadius: 5,
            pointHoverRadius: 7,
            pointBorderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            r: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                color: '#94a3b8',
                backdropColor: 'transparent',
                font: {
                  size: 11,
                  family: 'Inter, sans-serif',
                  weight: '500'
                }
              },
              grid: {
                color: '#334155',
                lineWidth: 1
              },
              angleLines: {
                color: '#334155',
                lineWidth: 1
              },
              pointLabels: {
                color: '#e2e8f0',
                font: {
                  size: 13,
                  family: 'Inter, sans-serif',
                  weight: '600'
                },
                padding: 10
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.95)',
              titleColor: '#e2e8f0',
              bodyColor: '#cbd5e1',
              borderColor: '#475569',
              borderWidth: 1,
              padding: 12,
              cornerRadius: 8,
              titleFont: {
                size: 13,
                weight: '600',
                family: 'Inter, sans-serif'
              },
              bodyFont: {
                size: 12,
                family: 'Inter, sans-serif'
              }
            }
          }
        }
      });
    }

    // Get count helper
    function getCount(item) {
      if (!item) return 0;
      if (Array.isArray(item)) return item.length;
      if (typeof item === 'object') return Object.keys(item).length;
      return 1;
    }

    // Search functionality
    searchBox.addEventListener('input', (e) => {
      // Sanitize search input
      const rawSearch = e.target.value.toLowerCase();
      const searchTerm = sanitizeHTML(rawSearch);

      if (!searchTerm) {
        filteredData = [...tableData];
      } else {
        filteredData = tableData.filter(row =>
          row.type.toLowerCase().includes(searchTerm) ||
          row.value.toLowerCase().includes(searchTerm)
        );
      }

      currentPage = 1;
      renderTable();
    });

    // Sorting functionality
    document.querySelectorAll('.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.column;

        if (sortColumn === column) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = column;
          sortDirection = 'asc';
        }

        // Update UI
        document.querySelectorAll('.sortable').forEach(header => {
          header.classList.remove('sorted-asc', 'sorted-desc');
        });
        th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

        // Sort data
        filteredData.sort((a, b) => {
          const aVal = a[column].toLowerCase();
          const bVal = b[column].toLowerCase();

          if (sortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
          } else {
            return aVal < bVal ? 1 : -1;
          }
        });

        renderTable();
      });
    });

    // Render table
    function renderTable() {
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageData = filteredData.slice(start, end);

      // Render rows - sanitize all data before rendering
      tableBody.innerHTML = pageData.map(row => `
        <tr>
          <td><span class="type-badge">${sanitizeHTML(row.type)}</span></td>
          <td>${sanitizeHTML(row.value)}</td>
        </tr>
      `).join('');

      // Update pagination info
      paginationInfo.textContent = `Showing ${start + 1}-${Math.min(end, filteredData.length)} of ${filteredData.length} results`;

      // Render pagination
      renderPagination();
    }

    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);

      let html = `
        <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">Previous</button>
      `;

      // Show page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (
          i === 1 ||
          i === totalPages ||
          (i >= currentPage - 2 && i <= currentPage + 2)
        ) {
          html += `
            <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>
          `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += `<span style="padding: 0.5rem;">...</span>`;
        }
      }

      html += `
        <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Next</button>
      `;

      pagination.innerHTML = html;
    }

    // Change page
    function changePage(page) {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
    }

    // Export CSV
    exportCsvBtn.addEventListener('click', () => {
      const csvContent = [
        ['Type', 'Value'],
        ...tableData.map(row => [row.type, row.value])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

      downloadFile(csvContent, `${domainTitle.textContent}_survey.csv`, 'text/csv');
    });

    // Export JSON
    exportJsonBtn.addEventListener('click', () => {
      const jsonContent = JSON.stringify(apiResponse, null, 2);
      downloadFile(jsonContent, `${domainTitle.textContent}_survey.json`, 'application/json');
    });

    // Download file helper
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Show error
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    // Make changePage global for onclick handlers
    window.changePage = changePage;
  </script>
</body>
</html>
